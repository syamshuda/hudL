<?php
/**
 * File: ruang_kelas_siswa.php
  * Halaman untuk siswa melihat dan berinteraksi dengan alur belajar di dalam kelas.
   *
    * PERUBAHAN: Kuis yang sudah dikerjakan kini bisa di-review.
     */

     require_once 'config/koneksi.php';

     // Proteksi halaman: Pastikan siswa sudah login
     if (!isset($_SESSION['user_id']) || $_SESSION['peran'] != 'siswa') {
         header("Location: login.php");
             exit();
             }
             $id_siswa = $_SESSION['user_id'];

             // Validasi ID Kelas dari URL
             if (!isset($_GET['id_kelas'])) {
                 header("Location: siswa_dashboard.php");
                     exit();
                     }
                     $id_kelas = intval($_GET['id_kelas']);

                     // Verifikasi: Pastikan siswa ini terdaftar di kelas yang diakses
                     $stmt_verifikasi = $koneksi->prepare("SELECT COUNT(*) FROM pendaftaran_kelas WHERE id_kelas = ? AND id_siswa = ?");
                     $stmt_verifikasi->bind_param("ii", $id_kelas, $id_siswa);
                     $stmt_verifikasi->execute();
                     $stmt_verifikasi->bind_result($jumlah);
                     $stmt_verifikasi->fetch();
                     $stmt_verifikasi->close();

                     if ($jumlah == 0) {
                         header("Location: siswa_dashboard.php?error=not_enrolled");
                             exit();
                             }

                             // Ambil data kelas untuk ditampilkan
                             $stmt_kelas = $koneksi->prepare("SELECT nama_kelas, deskripsi, mata_pelajaran FROM kelas WHERE id = ?");
                             $stmt_kelas->bind_param("i", $id_kelas);
                             $stmt_kelas->execute();
                             $result_kelas = $stmt_kelas->get_result();
                             $kelas = $result_kelas->fetch_assoc();
                             $stmt_kelas->close();

                             // Query gabungan untuk mendapatkan semua item alur belajar (materi & kuis)
                             $query_alur = "
                                 (SELECT
                                         'materi' as tipe, id, judul, konten, tipe_materi, waktu_buka, urutan, tanggal_dibuat
                                                 FROM materi WHERE id_kelas = ?)
                                                     UNION ALL
                                                         (SELECT
                                                                 'kuis' as tipe, id, judul_soal as judul, deskripsi as konten, 'kuis' as tipe_materi, waktu_buka, urutan, waktu_dibuat as tanggal_dibuat
                                                                         FROM soal WHERE id_kelas = ?)
                                                                             ORDER BY urutan ASC, tanggal_dibuat ASC
                                                                             ";
                                                                             $stmt_alur = $koneksi->prepare($query_alur);
                                                                             $stmt_alur->bind_param("ii", $id_kelas, $id_kelas);
                                                                             $stmt_alur->execute();
                                                                             $result_alur = $stmt_alur->get_result();
                                                                             $alur_belajar = [];
                                                                             while($row = $result_alur->fetch_assoc()) {
                                                                                 $alur_belajar[] = $row;
                                                                                 }
                                                                                 $stmt_alur->close();

                                                                                 // Siapkan statement untuk mengecek status penyelesaian
                                                                                 $stmt_cek_baca = $koneksi->prepare("SELECT COUNT(*) FROM status_baca_materi WHERE id_materi = ? AND id_siswa = ?");
                                                                                 $stmt_cek_submit_kuis = $koneksi->prepare("SELECT COUNT(*) FROM jawaban_siswa WHERE id_soal = ? AND id_siswa = ?");

                                                                                 function isItemSelesai($item, $id_siswa, $stmt_baca, $stmt_kuis) {
                                                                                     $count = 0;
                                                                                         if ($item['tipe'] == 'materi') {
                                                                                                 $stmt_baca->bind_param("ii", $item['id'], $id_siswa);
                                                                                                         $stmt_baca->execute();
                                                                                                                 $stmt_baca->bind_result($count);
                                                                                                                         $stmt_baca->fetch();
                                                                                                                                 $stmt_baca->reset(); 
                                                                                                                                     } elseif ($item['tipe'] == 'kuis') {
                                                                                                                                             $stmt_kuis->bind_param("ii", $item['id'], $id_siswa);
                                                                                                                                                     $stmt_kuis->execute();
                                                                                                                                                             $stmt_kuis->bind_result($count);
                                                                                                                                                                     $stmt_kuis->fetch();
                                                                                                                                                                             $stmt_kuis->reset();
                                                                                                                                                                                 }
                                                                                                                                                                                     return $count > 0;
                                                                                                                                                                                     }

                                                                                                                                                                                     include_once 'templates/header_siswa.php';
                                                                                                                                                                                     ?>

                                                                                                                                                                                     <nav aria-label="breadcrumb">
                                                                                                                                                                                       <ol class="breadcrumb">
                                                                                                                                                                                             <li class="breadcrumb-item"><a href="siswa_dashboard.php">Kelas Saya</a></li>
                                                                                                                                                                                                   <li class="breadcrumb-item active" aria-current="page"><?php echo htmlspecialchars($kelas['nama_kelas']); ?></li>
                                                                                                                                                                                                       </ol>
                                                                                                                                                                                                       </nav>

                                                                                                                                                                                                       <h1 class="mb-2"><?php echo htmlspecialchars($kelas['nama_kelas']); ?></h1>
                                                                                                                                                                                                       <h5 class="text-muted fw-normal mb-3"><?php echo htmlspecialchars($kelas['mata_pelajaran']); ?></h5>
                                                                                                                                                                                                       <p class="lead"><?php echo htmlspecialchars($kelas['deskripsi']); ?></p>

                                                                                                                                                                                                       <?php if(isset($_GET['status']) && $_GET['status'] == 'sukses_submit'): ?>
                                                                                                                                                                                                       <div class="alert alert-success alert-dismissible fade show" role="alert">
                                                                                                                                                                                                         Jawaban Anda telah berhasil dikumpulkan! Materi selanjutnya telah terbuka.
                                                                                                                                                                                                           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                                                                                                                                                                                           </div>
                                                                                                                                                                                                           <?php endif; ?>

                                                                                                                                                                                                           <hr>

                                                                                                                                                                                                           <h3><i class="bi bi-signpost-split-fill me-2"></i>Alur Belajar</h3>
                                                                                                                                                                                                           <p>Selesaikan setiap materi dan tugas secara berurutan untuk melanjutkan.</p>

                                                                                                                                                                                                           <div class="list-group">
                                                                                                                                                                                                               <?php
                                                                                                                                                                                                                   $sebelumnya_selesai = true; 

                                                                                                                                                                                                                       if (count($alur_belajar) > 0) {
                                                                                                                                                                                                                               foreach ($alur_belajar as $item) {
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                       $item_sudah_dikerjakan = isItemSelesai($item, $id_siswa, $stmt_cek_baca, $stmt_cek_submit_kuis);
                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                               $waktu_sekarang = new DateTime();
                                                                                                                                                                                                                                                                                           $waktu_buka = !empty($item['waktu_buka']) ? new DateTime($item['waktu_buka']) : null;
                                                                                                                                                                                                                                                                                                       $is_terjadwal = $waktu_buka && ($waktu_sekarang < $waktu_buka);

                                                                                                                                                                                                                                                                                                                   $icon = $item['tipe'] == 'materi' ? "<i class='bi bi-book-fill text-primary me-3'></i>" : "<i class='bi bi-patch-question-fill text-success me-3'></i>";
                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                           if ($is_terjadwal) {
                                                                                                                                                                                                                                                                                                                                                           echo "<div class='list-group-item list-group-item-light disabled d-flex justify-content-between align-items-center'>
                                                                                                                                                                                                                                                                                                                                                                                   <div>" . $icon . htmlspecialchars($item['judul']) . "</div>
                                                                                                                                                                                                                                                                                                                                                                                                           <span class='badge bg-info text-dark'><i class='bi bi-clock-fill'></i> Buka " . $waktu_buka->format('d M Y, H:i') . "</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                 $sebelumnya_selesai = false; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                             } 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         elseif (!$sebelumnya_selesai) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         echo "<div class='list-group-item list-group-item-light disabled d-flex justify-content-between align-items-center'>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div>" . $icon . htmlspecialchars($item['judul']) . "</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <span class='badge bg-secondary'><i class='bi bi-lock-fill'></i> Terkunci</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </div>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if ($item['tipe'] == 'materi') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           $tanda_selesai = $item_sudah_dikerjakan ? "<span class='badge bg-success'><i class='bi bi-check-circle-fill'></i> Sudah dibuka</span>" : "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               echo "<a href='#' class='list-group-item list-group-item-action d-flex justify-content-between align-items-center'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           data-bs-toggle='modal' data-bs-target='#materiModal'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       data-id-materi='" . $item['id'] . "'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   data-judul='" . htmlspecialchars($item['judul'], ENT_QUOTES) . "'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               data-konten='" . htmlspecialchars($item['konten'], ENT_QUOTES) . "'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           data-selesai='" . ($item_sudah_dikerjakan ? '1' : '0') . "'>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <div>" . $icon . htmlspecialchars($item['judul']) . "</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {$tanda_selesai}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </a>";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } elseif ($item['tipe'] == 'kuis') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // ===== PERUBAHAN DI SINI =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if ($item_sudah_dikerjakan) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Jika sudah dikerjakan, arahkan ke halaman review
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      echo "<a href='review_kuis.php?id_kuis={$item['id']}' class='list-group-item list-group-item-action d-flex justify-content-between align-items-center'>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div>" . $icon . htmlspecialchars($item['judul']) . "</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span class='badge bg-success'><i class='bi bi-check-circle-fill'></i> Lihat Jawaban & Nilai</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </a>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Jika belum, arahkan ke halaman pengerjaan kuis
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "<a href='kerjakan_kuis.php?id_kuis={$item['id']}' class='list-group-item list-group-item-action d-flex justify-content-between align-items-center'>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div>" . $icon . htmlspecialchars($item['judul']) . "</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </a>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // ===== AKHIR PERUBAHAN =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             $sebelumnya_selesai = $item_sudah_dikerjakan;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             echo "<div class='list-group-item text-center'>Belum ada materi atau kuis yang ditambahkan oleh guru.</div>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     $stmt_cek_baca->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         $stmt_cek_submit_kuis->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div class="modal fade" id="materiModal" tabindex="-1" aria-labelledby="materiModalLabel" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <div class="modal-content">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div class="modal-header">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <h5 class="modal-title" id="materiModalLabel"></h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <div class="modal-body" id="materiModalContent">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div class="modal-footer">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="tombolTutupMateri">Tutup</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     document.addEventListener('DOMContentLoaded', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const materiModal = document.getElementById('materiModal');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             let needsRefresh = false;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if (materiModal) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         materiModal.addEventListener('show.bs.modal', function (event) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     needsRefresh = false; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const button = event.relatedTarget;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const idMateri = button.getAttribute('data-id-materi');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const judul = button.getAttribute('data-judul');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const konten = button.getAttribute('data-konten');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const sudahSelesai = button.getAttribute('data-selesai') === '1';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             materiModal.querySelector('.modal-title').textContent = judul;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         materiModal.querySelector('.modal-body').innerHTML = konten;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (!sudahSelesai) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     needsRefresh = true; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const formData = new FormData();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     formData.append('id_materi', idMateri);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     fetch('tandai_dibaca.php', { method: 'POST', body: formData })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     .then(response => response.json())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     .then(data => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if (data.status !== 'success') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 console.error('Gagal menandai materi sebagai telah dibaca.');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         needsRefresh = false; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             .catch(error => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 console.error('Error:', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     needsRefresh = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 materiModal.addEventListener('hidden.bs.modal', function () {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if (needsRefresh) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             location.reload();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </script>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     $koneksi->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     include_once 'templates/footer.php';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ?>